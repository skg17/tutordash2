<%# 
  File: app/views/students/show.html.erb 
%>

<%# Helper Calculations for display %>
<%
  # Get cleaned subjects (assuming you have a 'subjects' array or method)
  subject_tags = (@student.subjects || []).map { |s| s.gsub(/["\[\]]/, '').strip.capitalize }
  student_status_class = @student.current? ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'
%>

<section class="flex justify-between items-center mb-8">
    
    <div class="flex flex-col">
        <%= link_to students_path, class: "flex items-center text-lg font-semibold text-gray-700 hover:text-purple-600 transition duration-150 mb-1" do %>
            <div class="icon mr-2" data-lucide="arrow-left" style="width: 20px; height: 20px;"></div>
            <span class="text-sm uppercase tracking-wider">Back to Students</span>
        <% end %>

        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900"><%= @student.name %></h1>
        <p class="text-gray-500 text-lg">Year <%= @student.year %></p>
    </div>

    <div class="flex space-x-3 mt-4 sm:mt-0">
        <%= button_to @student, method: :delete, data: { turbo_confirm: "Are you sure you want to permanently delete this student?"}, 
             form_class: "inline-block",
             class: "flex items-center px-4 py-2 text-sm font-semibold rounded-xl bg-red-500 text-white shadow-md hover:bg-red-600 transition duration-150" do %>
            <div class="icon mr-2" data-lucide="trash-2" style="width: 16px; height: 16px;"></div>
            Delete
        <% end %>

        <%= link_to edit_student_path(@student), class: "flex items-center px-4 py-2 text-sm font-semibold rounded-xl text-gray-700 border border-gray-300 bg-white hover:bg-gray-100 transition duration-150" do %>
            <div class="icon mr-2" data-lucide="edit" style="width: 16px; height: 16px;"></div>
            Edit
        <% end %>
    </div>
</section>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    
    <div class="lg:col-span-1">
        
        <%# UNIFIED CARD: Student Info, Contact, and Homework/Notes %>
        <div class="card-shadow bg-white p-6 rounded-3xl border border-gray-100">
            
            <%# --- 1. Student Information Section --- %>
            <div class="space-y-4">
                <div class="flex items-center">
                    <div class="icon mr-3 text-purple-600" data-lucide="user-square" style="width: 20px; height: 20px;"></div>
                    <h2 class="text-xl font-bold text-gray-900">Student Information</h2>
                </div>

                <%# Grades, Subjects, Rate %>
                <%# Grades %>
                <div class="grid grid-cols-2 gap-3">
                    <div class="p-3 rounded-lg bg-gray-50 flex items-center">
                        <div class="icon mr-2 text-purple-600" data-lucide="trending-up" style="width: 20px; height: 20px;"></div>
                        <div>
                            <p class="text-xs text-gray-500">Current Grade</p>
                            <p class="text-lg font-bold text-gray-900"><%= @student.grade %></p>
                        </div>
                    </div>
                    <div class="p-3 rounded-lg bg-green-50 flex items-center">
                        <div class="icon mr-2 text-green-700" data-lucide="target" style="width: 20px; height: 20px;"></div>
                        <div>
                            <p class="text-xs text-gray-500">Target Grade</p>
                            <p class="text-lg font-bold text-gray-900"><%= @student.target %></p>
                        </div>
                    </div>
                </div>

                <%# Subjects and Status %>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <p class="text-sm text-gray-500 mb-1">Subjects</p>
                        <div class="flex flex-wrap gap-2 leading-none">
                            <% subject_tags.each do |subject| %>
                                <span class="px-3 py-1 text-sm font-medium rounded-full bg-purple-100 text-purple-800">
                                    <%= subject %>
                                </span>
                            <% end %>
                        </div>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 mb-1">Status</p>
                        <div class="flex items-center"> 
                            <span class="text-sm font-medium px-2 py-1 rounded-full <%= student_status_class %>">
                                <%= @student.current? ? 'Active' : 'Inactive' %>
                            </span>
                        </div>
                    </div>
                </div>

                <%# Hourly Rate %>
                <div>
                    <p class="text-sm text-gray-500">Hourly Rate</p>
                    <p class="font-semibold text-gray-900">Â£<%= '%.2f' % @student.rate %> / hr</p>
                </div>
            </div>
            
            <div class="my-6 border-t border-gray-100"></div>

            <%# --- 2. Parent Contact Information Section --- %>
            <div class="space-y-4">
                <div class="flex items-center">
                    <div class="icon mr-3 text-purple-600" data-lucide="users" style="width: 20px; height: 20px;"></div>
                    <h2 class="text-xl font-bold text-gray-900">Parent Contact</h2>
                </div>
                
                <p class="font-semibold text-gray-900"><%= @student.parent_name %></p>

                <%# Email and Phone %>
                <div class="flex flex-col sm:flex-row sm:space-x-6 space-y-3 sm:space-y-0 text-gray-700">
                    <div class="flex items-center">
                        <div class="icon mr-2 text-purple-600" data-lucide="mail" style="width: 16px; height: 16px;"></div>
                        <a href="mailto:<%= @student.email %>" class="text-sm hover:text-purple-600"><%= @student.email %></a>
                    </div>
                    <div class="flex items-center">
                        <div class="icon mr-2 text-purple-600" data-lucide="phone" style="width: 16px; height: 16px;"></div>
                        <a href="tel:<%= @student.phone %>" class="text-sm hover:text-purple-600"><%= @student.phone %></a>
                    </div>
                </div>
            </div>
            
            <div class="my-6 border-t border-gray-100"></div>

            <%# --- 3. Recent Homework/Notes Section --- %>
            <div class="space-y-4">
                <div class="flex items-center">
                    <div class="icon mr-3 text-purple-600" data-lucide="notebook-pen" style="width: 20px; height: 20px;"></div>
                    <h2 class="text-xl font-bold text-gray-900">Homework and Notes</h2>
                </div>

                <% if @recent_lessons.any? %>
                    <% @recent_lessons.first(3).each do |lesson| %>
                        <% timing_data = format_lesson_timing(lesson) %>
                        
                        <div class="space-y-1 pt-2">
                            
                            <%# Date | Subject Header %>
                            <div class="flex items-center text-sm font-semibold text-gray-700 space-x-3">
                                <div class="flex items-center">
                                    <div class="icon mr-1 text-purple-600" data-lucide="calendar" style="width: 14px; height: 14px;"></div>
                                    <span><%= timing_data[:formatted_date] %></span>
                                </div>

                                <%# The space-x-3 on the parent handles the gap %>
                                
                                <div class="flex items-center">
                                    <div class="icon mr-1 text-purple-600" data-lucide="book" style="width: 14px; height: 14px;"></div>
                                    <span><%= lesson.subject %></span>
                                </div>
                            </div>

                            <%# Homework/Notes Content %>
                            <p class="text-sm text-gray-600 italic leading-snug">
                                <%= lesson.homework.present? ? lesson.homework.truncate(100) : "No notes or homework recorded." %>
                            </p>
                        </div>
                    <% end %>
                <% else %>
                    <p class="text-gray-500 text-sm py-2">No recent completed lessons found.</p>
                <% end %>
            </div>
            
        </div>
    </div>

    <div class="lg:col-span-2 space-y-4">
                
        <div class="flex items-center">
            <div class="icon mr-3 text-purple-600" data-lucide="calendar-check" style="width: 20px; height: 20px;"></div>
            <h2 class="text-xl font-bold text-gray-900">Recent Lessons</h2>
        </div>
        
        <% if @display_lessons.any? %>
            <% @display_lessons.each do |lesson| %>
                <%
                    status_data = lesson_status_and_payment_data(lesson)
                    timing_data = format_lesson_timing(lesson)
                    
                    # Prepare homework display
                    homework_summary = lesson.homework.present? ? lesson.homework.truncate(30, omission: '...') : "No homework assigned."
                %>
                
                <%# Lesson Card (Wrapper, NO link_to) %>
                <div class="card-shadow bg-white p-6 rounded-2xl flex justify-between items-center border border-gray-100">
                    
                    <div class="flex-1 min-w-0 pr-4">
                        
                        <div class="flex items-center mb-3">
                            <div class="flex items-center space-x-2">
                                <div class="icon text-purple-600" data-lucide="book" style="width: 18px; height: 18px;"></div>
                                <p class="font-semibold text-gray-900"><%= lesson.subject %></p>
                            </div>
                            
                            <div class="flex items-center ml-4 space-x-2">
                                
                                <span class="px-3 py-1 text-xs font-semibold rounded-full <%= status_data[:status_class] %>">
                                    <%= status_data[:status_text] %>
                                </span>
                                
                                <span class="px-3 py-1 text-xs font-semibold rounded-full <%= status_data[:paid_class] %>">
                                    <%= status_data[:paid_text] %>
                                </span>
                            </div>
                        </div>
                        
                        <div class="flex items-center text-sm text-gray-600 space-x-6">
                            
                            <div class="flex items-center">
                                <div class="icon mr-2 text-purple-600" data-lucide="calendar" style="width: 16px; height: 16px;"></div>
                                <span><%= timing_data[:formatted_date] %></span>
                            </div>
                            
                            <div class="flex items-center">
                                <div class="icon mr-2 text-purple-600" data-lucide="clock" style="width: 16px; height: 16px;"></div>
                                <span><%= timing_data[:time_range] %></span>
                            </div>
                            
                        </div>
                    </div>
                    
                    <div class="flex flex-col space-y-2 ml-4 min-w-[200px]">
                        
                        <%= link_to "View Details", lesson_path(lesson), title: "See lesson details", class: "w-full px-4 py-2 text-sm font-semibold rounded-xl text-gray-700 border border-gray-300 hover:bg-gray-100 transition duration-150 text-center" %>

                        <div class="flex space-x-2">
                            <%# JOIN BUTTON (link_to - w-1/2) %>
                            <%= link_to "#", title: "Join Video Session", class: "flex items-center justify-center w-1/2 px-4 py-2 text-sm font-semibold rounded-xl bg-purple-600 text-white shadow-md hover:bg-purple-700 transition duration-150" do %>
                                <div class="icon" data-lucide="video" style="width: 16px; height: 16px;"></div>
                                <span class="ml-1 hidden sm:inline">Join</span>
                            <% end %>

                            <%# DELETE BUTTON (button_to - w-1/2 with form_class fix) %>
                            <%= button_to lesson, method: :delete, 
                                data: { turbo_confirm: "Are you sure you want to delete this lesson?"}, 
                                title: "Delete Lesson", 
                                form_class: "w-1/2", 
                                class: "flex items-center justify-center w-full px-4 py-2 text-sm font-semibold rounded-xl bg-red-500 text-white shadow-md hover:bg-red-600 transition duration-150" do %>
                                <div class="icon" data-lucide="trash-2" style="width: 16px; height: 16px;"></div>
                                <span class="ml-1 hidden sm:inline">Delete</span>
                            <% end %>
                        </div>
                    
                    </div>
                
                </div> <%# End of Lesson Card %>

            <% end %>
        <% else %>
            <p class="text-gray-500 p-4">No lessons recorded for <%= @student.name %> yet.</p>
        <% end %>
    </div>
</div>