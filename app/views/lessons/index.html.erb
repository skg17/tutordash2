<section class="flex justify-between items-center mb-8">
    <div>
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-1">Lessons</h1>
        <p class="text-gray-500">Track and manage all your tutoring sessions.</p>
    </div>
    <%= link_to new_lesson_path, class: "flex items-center px-6 py-3 bg-purple-600 text-white font-semibold rounded-xl shadow-lg hover:bg-purple-700 transition duration-150" do %>
        <div class="icon mr-2" data-lucide="plus" style="width: 20px; height: 20px;"></div>
        Schedule Lesson
    <% end %>
</section>

<div class="space-y-4">
    
    <% @lessons.each do |lesson| %>
        
        <%
            # 1. Calls the helper to get status and payment data
            status_data = lesson_status_and_payment_data(lesson)
            
            # 2. Calls the helper to get formatted date and time
            timing_data = format_lesson_timing(lesson)
        %>

        <div class="card-shadow bg-white p-6 rounded-2xl flex justify-between items-center border border-gray-100 shadow-md">
            
            <div class="flex-1 min-w-0 pr-4">
                
                <div class="flex items-center mb-3">
                    <% student_name = lesson.student&.name || "N/A" %>
                    <h3 class="text-lg font-bold text-gray-900 truncate">
                        <%= student_name %>
                    </h3>

                    <div class="flex items-center ml-3 space-x-2"> 
                        <span class="px-3 py-1 text-xs font-semibold rounded-full <%= status_data[:status_class] %>">
                            <%= status_data[:status_text] %>
                        </span>

                        <span class="px-3 py-1 text-xs font-semibold rounded-full <%= status_data[:paid_class] %>">
                            <%= status_data[:paid_text] %>
                        </span>
                    </div>
                </div>

                <div class="flex items-center text-sm text-gray-600 space-x-6">
                    
                    <div class="flex items-center">
                        <div class="icon mr-2 text-purple-600" data-lucide="book-open" style="width: 16px; height: 16px;"></div>
                        <span><%= lesson.subject %></span>
                    </div>
                    
                    <div class="flex items-center">
                        <div class="icon mr-2 text-purple-600" data-lucide="calendar" style="width: 16px; height: 16px;"></div>
                        <span><%= timing_data[:formatted_date] %></span>
                    </div>
                    
                    <div class="flex items-center">
                        <div class="icon mr-2 text-purple-600" data-lucide="clock" style="width: 16px; height: 16px;"></div>
                        <span><%= timing_data[:time_range] %></span>
                    </div>
                </div>
            </div>

            <div class="flex flex-col space-y-2 ml-4">
                
                <%= link_to "View Details", lesson_path(lesson), title: "See lesson details", class: "w-full px-4 py-2 text-sm font-semibold rounded-xl text-gray-700 border border-gray-300 hover:bg-gray-100 transition duration-150 text-center" %>

                <div class="flex space-x-2">
                    <%= link_to "https://meet.google.com", title: "Join Video Session", class: "flex items-center justify-center w-[100px] px-4 py-2 text-sm font-semibold rounded-xl bg-purple-600 text-white shadow-md hover:bg-purple-700 transition duration-150" do %>
                        <div class="icon" data-lucide="video" style="width: 16px; height: 16px;"></div>
                        <span class="ml-1 hidden sm:inline">Join</span>
                    <% end %>

                    <%= button_to lesson, method: :delete, data: { turbo_confirm: "Are you sure you want to delete this lesson?"}, title: "Delete Lesson", class: "flex items-center justify-center w-[100px] px-4 py-2 text-sm font-semibold rounded-xl bg-red-500 text-white shadow-md hover:bg-red-600 transition duration-150" do %>
                        <div class="icon" data-lucide="trash-2" style="width: 16px; height: 16px;"></div>
                        <span class="ml-1 hidden sm:inline">Delete</span>
                    <% end %>
                </div>
            
            </div>
            
        </div>

    <% end %>

    <% if @lessons.empty? %>
        <p class="text-center text-gray-500 py-10">No lessons scheduled yet. Click 'Schedule Lesson' to add one!</p>
    <% end %>

</div>