<section class="flex flex-col md:flex-row justify-between md:items-center mb-8 space-y-4 md:space-y-0 md:pt-0">
    <div>
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-1">Lessons</h1>
        <p class="text-gray-500">Track and manage all your tutoring sessions.</p>
    </div>
    
    <%# NEW LESSON BUTTON - w-full on mobile, shrinks on desktop, centered content %>
    <%= link_to new_lesson_path, class: "flex items-center justify-center w-full md:w-auto px-4 md:px-6 py-2 md:py-3 bg-purple-600 text-white font-semibold rounded-xl shadow-lg hover:bg-purple-700 transition duration-150 text-sm md:text-base" do %>
        <div class="icon mr-2" data-lucide="plus" style="width: 20px; height: 20px;"></div>
        <span class="hidden sm:inline">Schedule Lesson</span>
        <span class="sm:hidden">New Lesson</span>
    <% end %>
</section>

<div class="space-y-4">
    
    <% @lessons.each do |lesson| %>
        
        <%
            # 1. Calls the helper to get status and payment data
            status_data = lesson_status_and_payment_data(lesson)
            
            # 2. Calls the helper to get formatted date and time
            timing_data = format_lesson_timing(lesson)
        %>

        <%# MAIN CARD CONTAINER FIX: Change to flex-col on mobile (default) and switch to flex-row on medium screens (md:flex-row) %>
        <div class="card-shadow bg-white p-4 sm:p-6 rounded-2xl flex flex-col md:flex-row justify-between items-start md:items-center border border-gray-100 shadow-md">
            
            <%# CONTENT BLOCK - Takes full width on mobile %>
            <div class="flex-1 w-full min-w-0 pr-0 md:pr-4 mb-4 md:mb-0">
                
                <div class="flex flex-col sm:flex-row sm:items-center mb-3">
                    <% student_name = lesson.student&.name || "N/A" %>
                    <h3 class="text-lg font-bold text-gray-900 truncate">
                        <%= student_name %>
                    </h3>

                    <%# Status Pills - Margin top added for mobile stacking %>
                    <div class="flex items-center mt-1 sm:mt-0 sm:ml-3 space-x-2"> 
                        <span class="px-3 py-1 text-xs font-semibold rounded-full <%= status_data[:status_class] %>">
                            <%= status_data[:status_text] %>
                        </span>

                        <span class="px-3 py-1 text-xs font-semibold rounded-full <%= status_data[:paid_class] %>">
                            <%= status_data[:paid_text] %>
                        </span>
                    </div>
                </div>

                <%# METADATA BLOCK - Change to flex-col on mobile and flex-row on small screens and up %>
                <div class="flex flex-col sm:flex-row text-sm text-gray-600 sm:space-x-6 space-y-1 sm:space-y-0">
                    
                    <div class="flex items-center">
                        <div class="icon mr-2 text-purple-600" data-lucide="book-open" style="width: 16px; height: 16px;"></div>
                        <span><%= lesson.subject %></span>
                    </div>
                    
                    <div class="flex items-center">
                        <div class="icon mr-2 text-purple-600" data-lucide="calendar" style="width: 16px; height: 16px;"></div>
                        <span><%= timing_data[:formatted_date] %></span>
                    </div>
                    
                    <div class="flex items-center">
                        <div class="icon mr-2 text-purple-600" data-lucide="clock" style="width: 16px; height: 16px;"></div>
                        <span><%= timing_data[:time_range] %></span>
                    </div>
                </div>
            </div>

            <%# ACTION BUTTONS BLOCK - Takes full width on mobile, moves to the right on desktop %>
            <div class="w-full md:w-auto flex flex-col space-y-2 mt-4 md:mt-0 ml-0 md:ml-4">
                
                <%# View Details Button - Full width on mobile %>
                <%= link_to "View Details", lesson_path(lesson), title: "See lesson details", class: "w-full px-4 py-2 text-sm font-semibold rounded-xl text-gray-700 border border-gray-300 hover:bg-gray-100 transition duration-150 text-center" %>

                <%# Join/Delete Buttons - Using custom width for guaranteed 50/50 split %>
                <div class="flex space-x-2 w-full">
                    
                    <%# Join Button - Uses calc(50%-4px) for exact width %>
                    <%= link_to "https://meet.google.com", title: "Join Video Session", 
                        class: "flex items-center justify-center w-[calc(50%-4px)] min-w-0 px-3 py-2 text-sm font-semibold rounded-xl bg-purple-600 text-white shadow-md hover:bg-purple-700 transition duration-150" do %>
                        <div class="icon" data-lucide="video" style="width: 16px; height: 16px;"></div>
                        <span class="ml-1">Join</span>
                    <% end %>

                    <%= button_to lesson, method: :delete, data: { turbo_confirm: "Are you sure you want to delete this lesson?"}, title: "Delete Lesson", 
                        class: "flex items-center justify-center w-full min-w-0 px-3 py-2 text-sm font-semibold rounded-xl bg-red-500 text-white shadow-md hover:bg-red-600 transition duration-150",
                        form: { class: "w-[calc(50%-4px)] min-w-0" } do %>
                        <div class="icon" data-lucide="trash-2" style="width: 16px; height: 16px;"></div>
                        <span class="ml-1">Delete</span>
                    <% end %>
                </div>
            
            </div>
            
        </div>

    <% end %>

    <% if @lessons.empty? %>
        <p class="text-center text-gray-500 py-10">No lessons scheduled yet. Click 'Schedule Lesson' to add one!</p>
    <% end %>

</div>
